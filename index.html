<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HH mod+global — Документация</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2333;
    --border: #30363d;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --accent: #58a6ff;
    --accent2: #3fb950;
    --accent3: #d29922;
    --red: #f85149;
    --code-bg: #1a1f2b;
    --table-header: #1a2233;
    --table-odd: #161b22;
    --table-even: #0d1117;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.7;
    font-size: 15px;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 40px 32px 80px;
  }

  /* ===== HEADER ===== */
  .doc-header {
    text-align: center;
    padding: 48px 0 40px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 48px;
  }
  .doc-header h1 {
    font-size: 36px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 12px;
    letter-spacing: -0.5px;
  }
  .doc-header .subtitle {
    font-size: 17px;
    color: var(--text-muted);
  }
  .doc-header .badge {
    display: inline-block;
    margin-top: 16px;
    padding: 4px 14px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-radius: 20px;
    background: rgba(88, 166, 255, 0.12);
    color: var(--accent);
    border: 1px solid rgba(88, 166, 255, 0.25);
  }

  /* ===== TOC ===== */
  .toc {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px 28px;
    margin-bottom: 48px;
  }
  .toc h2 {
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-muted);
    margin-bottom: 14px;
    border: none;
    padding: 0;
  }
  .toc ol {
    list-style: none;
    counter-reset: toc;
    padding: 0;
  }
  .toc li {
    counter-increment: toc;
    margin-bottom: 6px;
  }
  .toc li::before {
    content: counter(toc, decimal-leading-zero);
    color: var(--accent);
    font-weight: 600;
    font-size: 13px;
    margin-right: 10px;
    font-family: 'SF Mono', 'Fira Code', Consolas, monospace;
  }
  .toc a {
    color: var(--text);
    text-decoration: none;
    transition: color 0.15s;
  }
  .toc a:hover { color: var(--accent); }

  /* ===== SECTIONS ===== */
  section { margin-bottom: 56px; }

  h2 {
    font-size: 26px;
    font-weight: 700;
    color: #fff;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--accent);
    margin-bottom: 24px;
  }
  h3 {
    font-size: 19px;
    font-weight: 600;
    color: var(--accent);
    margin-top: 32px;
    margin-bottom: 12px;
  }
  h4 {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent3);
    margin-top: 24px;
    margin-bottom: 8px;
  }

  p { margin-bottom: 14px; }

  /* ===== LISTS ===== */
  ul, ol {
    padding-left: 24px;
    margin-bottom: 14px;
  }
  li { margin-bottom: 5px; }
  li ul, li ol { margin-top: 5px; margin-bottom: 5px; }

  /* ===== CODE ===== */
  code {
    font-family: 'SF Mono', 'Fira Code', Consolas, 'Courier New', monospace;
    font-size: 13px;
    background: var(--code-bg);
    color: #ff7b72;
    padding: 2px 7px;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.06);
  }

  pre {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 18px 20px;
    overflow-x: auto;
    margin: 16px 0;
    line-height: 1.5;
  }
  pre code {
    background: none;
    border: none;
    padding: 0;
    color: var(--text);
    font-size: 13px;
  }

  /* ===== TABLES ===== */
  table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
    font-size: 14px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border);
  }
  th {
    background: var(--table-header);
    color: var(--accent);
    font-weight: 600;
    text-align: left;
    padding: 10px 14px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border);
  }
  td {
    padding: 9px 14px;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
  }
  tr:nth-child(odd) td { background: var(--table-odd); }
  tr:nth-child(even) td { background: var(--table-even); }
  tr:last-child td { border-bottom: none; }

  /* ===== SPECIAL BLOCKS ===== */
  .diagram {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    overflow-x: auto;
    font-family: 'SF Mono', 'Fira Code', Consolas, monospace;
    font-size: 13px;
    line-height: 1.4;
    white-space: pre;
    color: var(--text-muted);
  }

  .flow {
    text-align: center;
    padding: 20px 0;
    margin: 16px 0;
  }
  .flow-chain {
    display: inline-flex;
    align-items: center;
    gap: 0;
    flex-wrap: wrap;
    justify-content: center;
  }
  .flow-step {
    display: inline-block;
    padding: 8px 18px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 14px;
  }
  .flow-arrow {
    color: var(--text-muted);
    font-size: 18px;
    margin: 0 6px;
  }
  .flow-step.pending { background: rgba(210,153,34,0.15); color: var(--accent3); border: 1px solid rgba(210,153,34,0.3); }
  .flow-step.open { background: rgba(88,166,255,0.12); color: var(--accent); border: 1px solid rgba(88,166,255,0.25); }
  .flow-step.closing { background: rgba(248,81,73,0.12); color: var(--red); border: 1px solid rgba(248,81,73,0.25); }
  .flow-step.closed { background: rgba(63,185,80,0.12); color: var(--accent2); border: 1px solid rgba(63,185,80,0.25); }
  .flow-step.archive { background: rgba(139,148,158,0.12); color: var(--text-muted); border: 1px solid rgba(139,148,158,0.25); }

  .callout {
    border-left: 4px solid var(--accent);
    background: rgba(88, 166, 255, 0.06);
    padding: 14px 18px;
    border-radius: 0 8px 8px 0;
    margin: 16px 0;
  }
  .callout.warn {
    border-left-color: var(--accent3);
    background: rgba(210, 153, 34, 0.06);
  }
  .callout.critical {
    border-left-color: var(--red);
    background: rgba(248, 81, 73, 0.06);
  }
  .callout strong {
    color: var(--accent);
  }
  .callout.warn strong { color: var(--accent3); }
  .callout.critical strong { color: var(--red); }

  .example-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    margin: 16px 0;
  }
  .example-block .title {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--accent2);
    margin-bottom: 10px;
    font-weight: 600;
  }

  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin: 16px 0;
  }
  .grid-2 .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 18px;
  }
  .grid-2 .card h4 {
    margin-top: 0;
    margin-bottom: 8px;
  }

  strong { color: #fff; }
  em { color: var(--text-muted); font-style: italic; }
  hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 48px 0;
  }

  @media print {
    body { background: #fff; color: #111; font-size: 11pt; }
    .container { max-width: 100%; padding: 0; }
    code { background: #f4f4f4; color: #c7254e; border-color: #ddd; }
    pre { background: #f8f8f8; border-color: #ddd; }
    pre code { color: #333; }
    h2 { border-bottom-color: #333; color: #111; }
    h3 { color: #1a5276; }
    h4 { color: #7d6608; }
    th { background: #eee; color: #333; }
    td { background: #fff !important; }
    .doc-header { border-bottom-color: #ccc; }
    .doc-header h1 { color: #111; }
    .badge { background: #eef; color: #336; border-color: #cce; }
    .toc { background: #f8f8f8; border-color: #ddd; }
    .callout { background: #f0f6ff; }
    .callout.warn { background: #fff8e6; }
    .callout.critical { background: #fff0f0; }
    .diagram { background: #f8f8f8; color: #555; border-color: #ddd; }
    .flow-step { border-width: 2px; }
    .example-block { background: #f8f8f8; border-color: #ddd; }
    .grid-2 .card { background: #f8f8f8; border-color: #ddd; }
    var { color: #111; }
    strong { color: #111; }
  }
</style>
</head>
<body>
<div class="container">

<!-- ==================== HEADER ==================== -->
<div class="doc-header">
  <h1>HH mod+global</h1>
  <div class="subtitle">Торговый бот для Gate.io &mdash; шорт на споте через HH и GP стратегии</div>
  <div class="badge">v8 &bull; 24/7 &bull; Автоматический</div>
</div>

<!-- ==================== TOC ==================== -->
<nav class="toc">
  <h2>Содержание</h2>
  <ol>
    <li><a href="#arch">Архитектура</a></li>
    <li><a href="#hh">Стратегия HH (Higher High)</a></li>
    <li><a href="#gp">Стратегия GP (Global Pump)</a></li>
    <li><a href="#lifecycle">Жизненный цикл позиции</a></li>
    <li><a href="#exit">Логика выходов</a></li>
    <li><a href="#capital">Капитал и лимиты</a></li>
    <li><a href="#recovery">Crash Recovery</a></li>
    <li><a href="#storage">Хранение данных</a></li>
    <li><a href="#protection">Защитные механизмы</a></li>
    <li><a href="#config">Настройки</a></li>
    <li><a href="#dashboard">Дашборд</a></li>
    <li><a href="#telegram">Telegram</a></li>
    <li><a href="#tests">Тестирование</a></li>
  </ol>
</nav>

<!-- ==================== 1. ARCHITECTURE ==================== -->
<section id="arch">
  <h2>1. Архитектура</h2>
  <p>Спот-бот для биржи Gate.io. Продаёт токены на локальных максимумах, откупает ниже. Два режима входа &mdash; <strong>HH</strong> (Higher High) и <strong>GP</strong> (Global Pump). Цикл каждые 10 секунд.</p>

  <div class="diagram">SupervisorAgent  (supervisor.py &mdash; главный мозг)
  │
  │  Каждые 10 сек:
  │  1. Рыночные данные     5. GP ордера
  │  2. Flash crash check   6. Fill detection
  │  3. Stale ордера        7. Exit management
  │  4. HH ордера           8. Очистка
  │
  ├──► ExitManager          ├──► StateManager
  │    exit_manager.py      │    state_manager.py
  │    Лимитные выходы,     │    Thread-safe state,
  │    трекинг max_high     │    делегирует в SQLite
  │                         │
  ├──► GateExchange         └──► SQLite (WAL) + JSON
  │    exchange.py
  │    CCXT обёртка
  │
  └──► EventBus
       events.py
       Pub/Sub для Telegram</div>

  <h3>Файлы и ответственности</h3>
  <table>
    <tr><th>Файл</th><th>Строк</th><th>Что делает</th></tr>
    <tr><td><code>supervisor.py</code></td><td>~1400</td><td>Главный цикл. HH/GP ордера, детекция филлов, crash recovery</td></tr>
    <tr><td><code>exit_manager.py</code></td><td>~300</td><td>Логика выходов: лимитные ордера, трекинг max_high, смена режимов</td></tr>
    <tr><td><code>state_manager.py</code></td><td>~500</td><td>Потокобезопасное хранилище. Делегирует позиции/ордера в SQLite</td></tr>
    <tr><td><code>database.py</code></td><td>~870</td><td>SQLite с WAL. Позиции, ордера, история, GP state</td></tr>
    <tr><td><code>strategy.py</code></td><td>~550</td><td>Чистые функции: поиск HH, расчёт exit level, GP grid</td></tr>
    <tr><td><code>models.py</code></td><td>~225</td><td>Dataclass-ы: Position, PendingOrder, MarketState</td></tr>
    <tr><td><code>exchange.py</code></td><td>&mdash;</td><td>CCXT обёртка для Gate.io API</td></tr>
    <tr><td><code>settings.py</code></td><td>~240</td><td>config.json с hot reload и dot notation</td></tr>
    <tr><td><code>events.py</code></td><td>~180</td><td>Pub/Sub EventBus для коммуникации между компонентами</td></tr>
  </table>
</section>

<hr>

<!-- ==================== 2. HH STRATEGY ==================== -->
<section id="hh">
  <h2>2. Стратегия HH (Higher High)</h2>

  <h3>Идея</h3>
  <p>Шорт на споте. Токены уже куплены и лежат на балансе. Бот <strong>продаёт</strong> их на уровнях Higher High (локальные максимумы), а потом <strong>откупает дешевле</strong> через лимитный ордер.</p>

  <h3>Поиск уровней HH</h3>
  <ol>
    <li>Берём <strong>1080 часовых свечей</strong> (~45 дней)</li>
    <li>Считаем недельный диапазон (low/high за последние 8 дней)</li>
    <li>Ищем свинг-хаи: свеча выше 2-х соседей слева и 2-х справа</li>
    <li>Фильтры:
      <ul>
        <li>Выше текущей цены, но <strong>не дальше 10%</strong></li>
        <li>В <strong>верхних 50%+</strong> недельного диапазона</li>
        <li>Не был пробит последующими свечами</li>
      </ul>
    </li>
    <li>Берём <strong>максимум 3</strong> уровня, сортируем по цене</li>
  </ol>

  <h3>Размещение ордеров</h3>
  <div class="callout">
    <strong>Бюджет:</strong> 50% от бюджета токена делится поровну на все видимые HH уровни.
  </div>
  <table>
    <tr><th>Видимых HH</th><th>Размер ордера</th><th>Пример ($60 бюджет)</th></tr>
    <tr><td>1</td><td>100% от 50%</td><td>$30 на 1 ордер</td></tr>
    <tr><td>2</td><td>50% от 50%</td><td>$15 на каждый</td></tr>
    <tr><td>3</td><td>33% от 50%</td><td>$10 на каждый</td></tr>
  </table>
  <ul>
    <li><strong>Лимит:</strong> максимум 3 НОВЫХ HH ордера за 12 часов (rate limit)</li>
    <li><strong>Минимум:</strong> $3 на ордер (лимит Gate.io)</li>
    <li><strong>Тип:</strong> limit sell (продаём токен на хае)</li>
  </ul>

  <h3>Динамическое перераспределение</h3>
  <p>Если набор HH уровней изменился (уровень пробит или появился новый):</p>
  <ol>
    <li>Отменить все текущие HH ордера</li>
    <li>Пересчитать бюджет с учётом уже открытых позиций</li>
    <li>Разместить новые ордера с правильными размерами</li>
    <li>Проверить 12ч лимит <strong>ПОСЛЕ</strong> отмены (отменённые не считаются)</li>
  </ol>

  <h3>Stale-ордера</h3>
  <p>Если цена упала больше чем на <strong>10%</strong> ниже HH ордера &mdash; ордер отменяется. Когда цена вернётся, <code>manage_proactive_orders</code> разместит новый.</p>
</section>

<hr>

<!-- ==================== 3. GP STRATEGY ==================== -->
<section id="gp">
  <h2>3. Стратегия GP (Global Pump)</h2>

  <h3>Идея</h3>
  <p>Сетка sell-ордеров на случай сильного пампа. Размещается <strong>ВЫШЕ</strong> текущей цены (от +20% до +50%). Если токен сильно вырастет &mdash; ордера исполнятся и мы продадим на пике.</p>

  <h3>Параметры сетки</h3>
  <table>
    <tr><th>Параметр</th><th>По умолчанию</th><th>Описание</th></tr>
    <tr><td>Base price</td><td>текущая цена</td><td>Основа для расчёта сетки</td></tr>
    <tr><td>Start %</td><td>+20%</td><td>Начало сетки выше base</td></tr>
    <tr><td>End %</td><td>+50%</td><td>Конец сетки выше base</td></tr>
    <tr><td>Количество</td><td>10</td><td>Число ордеров в сетке</td></tr>
    <tr><td>Бюджет</td><td>$40</td><td>Суммарный бюджет</td></tr>
    <tr><td>Минимум</td><td>$3</td><td>Меньшие ордера отфильтровываются</td></tr>
  </table>

  <div class="callout warn">
    <strong>Вес экспоненциальный:</strong> больший бюджет на верхние уровни.
  </div>

  <h3>Обновление сетки</h3>
  <ol>
    <li><strong>Ежедневное</strong> &mdash; в 12:00 по Лиссабону. Новый base_price = текущая цена. Старые ордера отменяются, ставятся новые</li>
    <li><strong>По изменению настроек</strong> &mdash; если в дашборде поменяли Start%, End% или бюджет &mdash; сетка пересобирается с <strong>СОХРАНЁННЫМ</strong> base_price (не текущей ценой)</li>
    <li>Между обновлениями сетка <strong>не трогается</strong></li>
  </ol>

  <h3>Атомарность</h3>
  <p>После размещения <strong>КАЖДОГО</strong> ордера GP state сохраняется в SQLite. Если бот упадёт посреди построения сетки &mdash; при перезапуске он знает какие ордера уже стоят.</p>
</section>

<hr>

<!-- ==================== 4. LIFECYCLE ==================== -->
<section id="lifecycle">
  <h2>4. Жизненный цикл позиции</h2>

  <div class="flow">
    <div class="flow-chain">
      <span class="flow-step pending">PENDING</span>
      <span class="flow-arrow">&rarr;</span>
      <span class="flow-step open">OPEN</span>
      <span class="flow-arrow">&rarr;</span>
      <span class="flow-step closing">CLOSING</span>
      <span class="flow-arrow">&rarr;</span>
      <span class="flow-step closed">CLOSED</span>
      <span class="flow-arrow">&rarr;</span>
      <span class="flow-step archive">trade_history</span>
    </div>
  </div>

  <h3>Вход (fill detection)</h3>
  <p>Каждый цикл <code>check_order_fills()</code> проверяет pending ордера:</p>
  <ul>
    <li><strong>EXIT ордера пропускаются</strong> &mdash; ими занимается ExitManager</li>
    <li>Для HH/GP: запрос <code>exchange.get_order()</code> &rarr; проверка <code>filled</code> и <code>status</code></li>
  </ul>

  <div class="grid-2">
    <div class="card">
      <h4>Partial fill</h4>
      <p><em>status=open, filled &gt; 0</em></p>
      <ul>
        <li>Создаётся позиция на исполненную часть</li>
        <li><code>pump_low</code> берётся СЕЙЧАС (min за 13 свечей)</li>
        <li>HH: сразу размещается exit ордер</li>
        <li>pending order обновляется с новым <code>filled_tokens</code></li>
      </ul>
    </div>
    <div class="card">
      <h4>Full fill</h4>
      <p><em>status=closed</em></p>
      <ul>
        <li>Обрабатывается оставшийся остаток</li>
        <li>Ордер удаляется из pending</li>
        <li>Удаление гарантировано через <code>finally</code></li>
      </ul>
    </div>
  </div>

  <h3>Закрытие</h3>
  <p>Когда exit ордер исполнен (<code>status=closed</code>):</p>
  <ol>
    <li>Позиция закрывается (<code>status=CLOSED</code>, <code>exit_fill_price</code> записывается)</li>
    <li>HH капитал освобождается (для новых ордеров)</li>
    <li>Событие <code>POSITION_CLOSED</code> для Telegram уведомления</li>
  </ol>

  <h3>Архивация</h3>
  <p><code>remove_closed_positions()</code> переносит закрытые позиции в таблицу <code>trade_history</code> с рассчитанным PnL.</p>
</section>

<hr>

<!-- ==================== 5. EXIT LOGIC ==================== -->
<section id="exit">
  <h2>5. Логика выходов</h2>
  <p>Два режима. Переход <strong>необратимый</strong>.</p>

  <div class="grid-2">
    <div class="card">
      <h4>retrace_60 (по умолчанию)</h4>
      <ul>
        <li>Отслеживается <code>max_high</code></li>
        <li>Exit = max_high &minus; (max_high &minus; pump_low) &times; 60%</li>
        <li>При новом хае: отменить старый exit, поставить новый</li>
        <li>Гарантия: exit &le; entry &times; 0.99</li>
      </ul>
    </div>
    <div class="card">
      <h4>profit_1pct (необратимый)</h4>
      <ul>
        <li>Активируется когда retrace level &gt; entry &times; 0.99</li>
        <li>Фиксированный exit = entry &times; 0.99</li>
        <li><code>max_high</code> больше не трекается</li>
        <li>Обратно в retrace_60 <strong>не возвращается</strong></li>
      </ul>
    </div>
  </div>

  <div class="callout">
    <strong>Переключение:</strong> когда 60% retrace сам по себе даёт &gt;1% прибыли &mdash; нет смысла трекать дальше, фиксируем 1%.
  </div>

  <div class="example-block">
    <div class="title">Пример расчёта</div>
<pre><code>Entry:     $0.0100 (продали)
pump_low:  $0.0080
max_high:  $0.0120

60% retrace: $0.0120 - ($0.0120 - $0.0080) &times; 0.6 = $0.0096
Min profit:  $0.0100 &times; 0.99 = $0.0099

$0.0096 &lt; $0.0099 &rarr; exit = $0.0096 (retrace_60 mode)
PnL: ($0.01 - $0.0096) / $0.01 = <strong>+4%</strong>

--- max_high растёт до $0.015 ---

60% retrace: $0.015 - ($0.015 - $0.008) &times; 0.6 = $0.0108
$0.0108 &gt; $0.0099 &rarr; переключение на profit_1pct
exit = $0.0099, PnL: <strong>+1%</strong></code></pre>
  </div>
</section>

<hr>

<!-- ==================== 6. CAPITAL ==================== -->
<section id="capital">
  <h2>6. Капитал и лимиты</h2>

  <h3>HH Isolated Balance</h3>
  <ul>
    <li><code>hh_used</code> &mdash; сколько $ заблокировано в HH ордерах</li>
    <li>Размещение: <code>add_hh_capital(size_usdt)</code></li>
    <li>Отмена/закрытие: <code>release_hh_capital(size_usdt)</code></li>
    <li>Защита от минуса: <code>max(0, current &minus; amount)</code></li>
    <li><code>sync_hh_capital()</code> пересчитывает из БД</li>
  </ul>

  <h3>Лимиты (HH Isolated Balance)</h3>
  <p>Система изолированного бюджета контролирует все HH ордера. Ограничения проверяются <strong>до</strong> размещения каждого ордера в <code>manage_proactive_orders()</code>:</p>
  <table>
    <tr><th>Лимит</th><th>Значение</th><th>Зачем</th></tr>
    <tr><td><code>total_budget</code></td><td>$20 (настраивается)</td><td>Максимальный $ на все HH ордера. <code>hh_used &ge; total_budget</code> &rarr; стоп</td></tr>
    <tr><td><code>max_orders_total</code></td><td>6 (настраивается)</td><td>Максимум HH ордеров одновременно по всем токенам</td></tr>
    <tr><td><code>max_orders_per_token</code></td><td>3 (настраивается)</td><td>Максимум HH ордеров на один токен</td></tr>
    <tr><td>12h window</td><td>&le; 3 HH / токен / 12ч</td><td>Rate limit: не более 3 новых HH ордеров за скользящие 12 часов</td></tr>
    <tr><td>Per-token budget</td><td>настраивается</td><td>Индивидуальный бюджет через дашборд. 50% идёт на HH</td></tr>
    <tr><td>Min order</td><td>$3</td><td>Минимальный размер ордера (лимит Gate.io)</td></tr>
  </table>

  <h3>Подсчёт 12ч окна</h3>
  <div class="callout critical">
    <strong>Критический механизм.</strong> Считает УНИКАЛЬНЫЕ намерения (intents), не количество позиций.
  </div>
  <ol>
    <li><strong>Pending HH ордера</strong> в окне &rarr; каждый = 1 intent</li>
    <li><strong>Полностью исполненные</strong> (нет в pending, есть позиции) &rarr; <code>COUNT(DISTINCT entry_order_id)</code> = 1 на ордер</li>
    <li><strong>Partial fill</strong> с pending: ордер всё ещё в таблице &rarr; считается как 1 (позиции не дублируются)</li>
  </ol>
</section>

<hr>

<!-- ==================== 7. CRASH RECOVERY ==================== -->
<section id="recovery">
  <h2>7. Crash Recovery</h2>
  <p>При запуске <code>_sync_with_exchange()</code> проверяет согласованность state с биржей:</p>

  <h3>Orphaned ордера <em>(на бирже, но не в state)</em></h3>
  <ul>
    <li>Восстанавливаются в pending orders</li>
    <li>Тип: из БД или по эвристике (sell &gt;15% выше цены &rarr; GP, иначе HH)</li>
  </ul>

  <h3>Stale ордера <em>(в state, но не на бирже)</em></h3>
  <ul>
    <li>Удаляются из state</li>
  </ul>

  <h3>Exit-ы, исполненные пока бот был выключен</h3>
  <p>Для каждой OPEN/CLOSING позиции с <code>exit_order_id</code>:</p>
  <table>
    <tr><th>Статус на бирже</th><th>Действие</th></tr>
    <tr><td><code>closed</code></td><td>Позиция закрывается, капитал освобождается</td></tr>
    <tr><td><code>canceled</code></td><td><code>exit_order_id</code> очищается, ExitManager поставит новый</td></tr>
    <tr><td><code>open</code></td><td>Ничего не делаем</td></tr>
  </table>

  <h3>GP state</h3>
  <ul>
    <li>GP ордера на бирже без GP state &rarr; state восстанавливается</li>
    <li><code>applied_*</code> поля = 0 &rarr; заполняются из настроек токена</li>
  </ul>
</section>

<hr>

<!-- ==================== 8. STORAGE ==================== -->
<section id="storage">
  <h2>8. Хранение данных</h2>

  <div class="grid-2">
    <div class="card">
      <h4>SQLite (WAL mode)</h4>
      <table>
        <tr><th>Таблица</th><th>Данные</th></tr>
        <tr><td><code>positions</code></td><td>Все позиции</td></tr>
        <tr><td><code>orders</code></td><td>Pending ордера</td></tr>
        <tr><td><code>trade_history</code></td><td>Архив с PnL</td></tr>
        <tr><td><code>gp_state</code></td><td>GP сетка</td></tr>
      </table>
      <ul style="margin-top:10px">
        <li>Parameterized queries</li>
        <li>Column allowlist для UPDATE</li>
        <li>Thread-safe через <code>_db_lock</code></li>
      </ul>
    </div>
    <div class="card">
      <h4>JSON (bot_state.json)</h4>
      <ul>
        <li>Настройки токенов</li>
        <li>Proactive order state</li>
        <li>Капитал (hh_used, gp_used)</li>
        <li>Pending cancellations</li>
      </ul>
      <p style="margin-top:10px"><em>Atomic write: .tmp файл &rarr; rename</em></p>
    </div>
  </div>

  <h3>Миграция</h3>
  <p>При первом запуске: если <code>bot_state.json</code> содержит позиции/ордера, они мигрируются в SQLite в одной транзакции.</p>
</section>

<hr>

<!-- ==================== 9. PROTECTION ==================== -->
<section id="protection">
  <h2>9. Защитные механизмы</h2>
  <table>
    <tr><th>Механизм</th><th>Описание</th></tr>
    <tr><td>Flash crash detection</td><td>Падение &gt;30% за 12ч &rarr; пропуск цикла</td></tr>
    <tr><td>Stale order cleanup</td><td>HH ордер &gt;10% от цены &rarr; отмена</td></tr>
    <tr><td>Double-close guard</td><td>Перечитать позицию из БД перед закрытием</td></tr>
    <tr><td>Rate limit</td><td>0.5с между API вызовами (ордера)</td></tr>
    <tr><td>HH Isolated Balance</td><td>Бюджет ($20), макс. ордеров (6 total, 3 per token) &mdash; контролирует все HH ордера</td></tr>
    <tr><td>12h window</td><td>Максимум 3 новых HH на токен за 12ч</td></tr>
    <tr><td>Capital floor</td><td><code>hh_used</code> не уходит ниже 0</td></tr>
    <tr><td>Periodic re-sync</td><td>Каждые 30 циклов (~5 мин) полная синхронизация</td></tr>
    <tr><td>Anomaly detection</td><td>Каждые 10 циклов проверка orphaned/stale</td></tr>
    <tr><td>Exponential backoff</td><td>При ошибках: 5с &rarr; 10с &rarr; 20с &rarr; ... &rarr; 60с</td></tr>
  </table>

  <h3>Авто-обнаружение токенов</h3>
  <p>Бот не требует ручной настройки списка токенов. Он сканирует спотовый баланс:</p>
  <ol>
    <li><code>fetch_balance()</code> &rarr; все токены</li>
    <li>Фильтр: не стейблкоин, баланс &gt; 0, стоимость &ge; $1</li>
    <li>Для каждого найденного токена: торговать</li>
  </ol>
</section>

<hr>

<!-- ==================== 10. CONFIG ==================== -->
<section id="config">
  <h2>10. Настройки (config.json)</h2>
<pre><code>{
  "pump_detection":  { "min_percent": 5, "lookback_hours": 12 },
  "hh_levels":       { "lookback_candles": 1080, "proximity_percent": 10, "max_levels": 3 },
  "weekly_range":    { "lookback_days": 8, "zone_min_percent": 50 },
  "exit":            { "retrace_percent": 60 },
  "global_pump":     { "grid_start_percent": 20, "grid_end_percent": 50,
                       "num_orders": 10, "budget": 40 },
  "capital":         { "proactive_budget": 10, "max_capital": 50 },
  "protection":      { "flash_crash_percent": 30, "pause_hours": 12 }
}</code></pre>
  <p>Дополнительно: per-token настройки через дашборд (бюджет, GP on/off, GP диапазон).</p>
</section>

<hr>

<!-- ==================== 11. DASHBOARD ==================== -->
<section id="dashboard">
  <h2>11. Дашборд</h2>
  <p>Веб-интерфейс на <strong>Flask</strong> (<code>dashboard_server.py</code>, порт 5001). Позволяет мониторить бота в реальном времени и управлять всеми параметрами без перезапуска.</p>

  <h3>Управление ботом</h3>
  <div class="grid-2">
    <div class="card">
      <h4>Start / Stop</h4>
      <ul>
        <li><strong>Start</strong> &mdash; запускает SupervisorAgent в фоновом потоке</li>
        <li><strong>Stop</strong> &mdash; останавливает бота + <strong>отменяет ВСЕ ордера</strong> на бирже + сбрасывает капитал</li>
      </ul>
    </div>
    <div class="card">
      <h4>Статус</h4>
      <ul>
        <li>Open positions / Pending orders</li>
        <li>HH / GP капитал использован</li>
        <li>Состояние бота (running / stopped)</li>
      </ul>
    </div>
  </div>

  <h3>Per-Token настройки</h3>
  <p>Каждый токен настраивается отдельно через <code>POST /api/settings/&lt;symbol&gt;</code>. При изменении настроек старые ордера отменяются и размещаются новые с обновлёнными параметрами.</p>

  <table>
    <tr><th>Параметр</th><th>По умолчанию</th><th>Описание</th></tr>
    <tr><td><code>budget</code></td><td>$10</td><td>Бюджет токена на HH стратегию. 50% идёт на текущую ситуацию, делится между видимыми HH уровнями</td></tr>
    <tr><td><code>range_days</code></td><td>8</td><td>Дней для расчёта недельного диапазона (low/high). Влияет на зону валидных HH</td></tr>
    <tr><td><code>zone_percent</code></td><td>50</td><td>Минимальная зона HH в недельном диапазоне. 50 = только верхняя половина</td></tr>
    <tr><td><code>retrace_percent</code></td><td>60</td><td>% ретрейса для расчёта exit level</td></tr>
    <tr><td><code>hh_proximity_percent</code></td><td>10</td><td>Макс. расстояние от текущей цены до HH уровня</td></tr>
  </table>

  <h3>GP настройки (per-token)</h3>
  <table>
    <tr><th>Параметр</th><th>По умолчанию</th><th>Описание</th></tr>
    <tr><td><code>gp_enabled</code></td><td>false</td><td>Вкл/выкл GP сетку для этого токена</td></tr>
    <tr><td><code>gp_start_percent</code></td><td>20</td><td>Начало сетки: base_price + X%. Чем меньше &mdash; тем ближе к текущей цене первый ордер</td></tr>
    <tr><td><code>gp_end_percent</code></td><td>50</td><td>Конец сетки: base_price + X%. Чем больше &mdash; тем выше последний ордер</td></tr>
    <tr><td><code>gp_budget</code></td><td>$40</td><td>Суммарный бюджет на GP сетку. Распределяется экспоненциально (больше на верхние уровни)</td></tr>
  </table>

  <div class="callout warn">
    <strong>При изменении GP настроек:</strong> сетка пересобирается с СОХРАНЁННЫМ base_price. Цена не перезапрашивается &mdash; это защита от случайного сброса сетки при корректировке параметров.
  </div>

  <h3>HH Isolated Balance (глобально)</h3>
  <p>Настройки изолированного бюджета для HH стратегии через <code>POST /api/hh/limits</code>:</p>
  <table>
    <tr><th>Параметр</th><th>По умолчанию</th><th>Описание</th></tr>
    <tr><td><code>total_budget</code></td><td>$20</td><td>Максимальный суммарный бюджет на все HH ордера</td></tr>
    <tr><td><code>max_orders_total</code></td><td>6</td><td>Макс. количество HH ордеров одновременно (все токены)</td></tr>
    <tr><td><code>max_orders_per_token</code></td><td>3</td><td>Макс. количество HH ордеров на один токен</td></tr>
  </table>

  <h3>Ручные действия</h3>
  <table>
    <tr><th>Действие</th><th>Endpoint</th><th>Что делает</th></tr>
    <tr><td>Отменить ордер</td><td><code>POST /api/orders/&lt;id&gt;/cancel</code></td><td>Отменяет на бирже, освобождает капитал. Бот может переставить на следующем цикле</td></tr>
    <tr><td>Отменить позицию</td><td><code>POST /api/positions/&lt;id&gt;/cancel</code></td><td>Отменяет exit ордер, закрывает позицию (exit_price=0, т.е. ручная отмена)</td></tr>
  </table>

  <h3>Мониторинг</h3>
  <table>
    <tr><th>Endpoint</th><th>Данные</th></tr>
    <tr><td><code>GET /api/spot-balances</code></td><td>Балансы всех токенов на споте + USDT</td></tr>
    <tr><td><code>GET /api/ohlcv/&lt;symbol&gt;</code></td><td>OHLCV свечи для графика (Lightweight Charts)</td></tr>
    <tr><td><code>GET /api/hh-levels/&lt;symbol&gt;</code></td><td>HH уровни + недельный диапазон + зона 50%</td></tr>
    <tr><td><code>GET /api/positions/&lt;symbol&gt;</code></td><td>Открытые позиции, pending ордера, proactive state, GP state</td></tr>
    <tr><td><code>GET /api/ticker/&lt;symbol&gt;</code></td><td>Текущая цена, bid, ask, 24h change</td></tr>
    <tr><td><code>GET /api/bot/status</code></td><td>Статус бота, капитал, HH status</td></tr>
    <tr><td><code>GET /api/hh/status</code></td><td>Детальный HH isolated balance</td></tr>
  </table>

  <div class="callout">
    <strong>Cross-process safety:</strong> дашборд и бот пишут в один <code>bot_state.json</code>. При сохранении настроек дашборд сначала перечитывает файл с диска, чтобы не затереть изменения бота.
  </div>
</section>

<hr>

<!-- ==================== 12. TELEGRAM ==================== -->
<section id="telegram">
  <h2>12. Telegram</h2>
  <p>Двусторонняя интеграция: бот отправляет <strong>нотификации</strong> о событиях и принимает <strong>команды</strong> для мониторинга.</p>

  <h3>Архитектура нотификаций</h3>
  <p>Работает через <strong>EventBus</strong> (pub/sub). Supervisor публикует события &rarr; <code>QAAgent</code> (<code>qa_agent.py</code>) подписывается и фильтрует &mdash; не все события уходят в Telegram, чтобы избежать спама.</p>

  <table>
    <tr><th>Событие</th><th>Telegram?</th><th>Описание</th></tr>
    <tr><td><code>ORDER_FILLED</code></td><td>Да</td><td>Ордер исполнен (entry). Показывает цену, размер, тип (HH/GP)</td></tr>
    <tr><td><code>ORDER_PARTIAL_FILL</code></td><td>Да</td><td>Частичное исполнение ордера</td></tr>
    <tr><td><code>POSITION_CLOSED</code></td><td>Да</td><td>Позиция закрыта. Показывает PnL</td></tr>
    <tr><td><code>FLASH_CRASH_DETECTED</code></td><td>Да</td><td>Обнаружен flash crash (&gt;30% за 12ч)</td></tr>
    <tr><td><code>ERROR_OCCURRED</code></td><td>Только CRITICAL</td><td>Ошибки бота. Только критические (crash, потеря соединения)</td></tr>
    <tr><td><code>GP_DAILY_UPDATE</code></td><td>Да</td><td>Ежедневная пересборка GP сетки (сводка)</td></tr>
    <tr><td><code>SUPERVISOR_STARTED/STOPPED</code></td><td>Да</td><td>Запуск/остановка бота</td></tr>
    <tr><td><code>POSITION_OPENED</code></td><td>Нет</td><td>Дубликат ORDER_FILLED, подавляется</td></tr>
    <tr><td><code>EXIT_MODE_CHANGED</code></td><td>Нет</td><td>Внутренний переход (retrace_60 &rarr; profit_1pct)</td></tr>
    <tr><td><code>HIGH_UPDATED</code></td><td>Нет</td><td>Рутинное обновление max_high</td></tr>
  </table>

  <h3>Telegram команды</h3>
  <p><code>TelegramCommands</code> (<code>telegram_commands.py</code>) слушает команды через long polling и отвечает inline-кнопками:</p>
  <table>
    <tr><th>Команда</th><th>Что делает</th></tr>
    <tr><td><code>/status</code></td><td>Статус бота: running/stopped, кол-во ордеров, позиций, HH бюджет, список токенов</td></tr>
    <tr><td><code>/orders</code></td><td>Все pending ордера, сгруппированные по токену (тип, цена, размер)</td></tr>
    <tr><td><code>/positions</code></td><td>Открытые позиции с PnL расчётом и exit target</td></tr>
    <tr><td><code>/chart</code></td><td>HH уровни, недельный диапазон, GP mode для каждого токена</td></tr>
    <tr><td><code>/menu</code></td><td>Inline-кнопки: Status, Orders, Positions, Chart, Refresh</td></tr>
  </table>

  <h3>Конфигурация</h3>
  <p>Через переменные окружения (<code>.env</code>):</p>
  <ul>
    <li><code>TELEGRAM_BOT_TOKEN</code> &mdash; токен бота от @BotFather</li>
    <li><code>TELEGRAM_CHAT_ID</code> &mdash; ID чата для нотификаций</li>
  </ul>
  <p>Listener запускается автоматически watchdog-ом в фоновом потоке (<code>run_in_background()</code>).</p>
</section>

<hr>

<!-- ==================== 13. TESTS ==================== -->
<section id="tests">
  <h2>13. Тестирование</h2>
  <div class="callout" style="border-left-color: var(--accent2); background: rgba(63,185,80,0.06);">
    <strong style="color: var(--accent2);">Все 28 тестов пройдены успешно.</strong> Покрытие: критические пути торговой логики, подсчёт ордеров, жизненный цикл позиций, капитал, PnL, fill detection, crash recovery.
  </div>
  <p><strong>28 юнит-тестов</strong> покрывают критические пути:</p>
  <table>
    <tr><th>Модуль</th><th>Тестов</th><th>Что покрыто</th></tr>
    <tr><td><code>test_models</code></td><td>4</td><td>PnL расчёт (positive, negative, zero), OrderType enum</td></tr>
    <tr><td><code>test_database</code></td><td>10</td><td>CRUD позиций/ордеров, 12ч окно (5 сценариев дедупликации)</td></tr>
    <tr><td><code>test_state_manager</code></td><td>5</td><td>HH капитал (add, release, floor, sync), настройки токенов</td></tr>
    <tr><td><code>test_supervisor</code></td><td>5</td><td>EXIT skip, HH fill &rarr; position, crash recovery (3 сценария)</td></tr>
    <tr><td><code>test_exit_manager</code></td><td>4</td><td>Exit fill &rarr; close, double-close guard, order placement</td></tr>
  </table>
  <p>Запуск:</p>
<pre><code>cd "C:\Users\Admin\Desktop\HH mod+global"
python -m pytest tests/ -v</code></pre>
</section>

</div>
</body>
</html>
